<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Chase Sapphire Checking</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
/* =========================
   2030 NEON–GLASS DASHBOARD
   ========================= */

:root{
  --bg:#0a0a10;
  --panel:#0e0f17;
  --panel-2:#0b0c14;
  --text:#e9e8f7;
  --muted:#a5a3c9;
  --grid:rgba(140,140,200,.06);

  --violet:#8b5cf6;
  --pink:#ec4899;
  --sky:#60a5fa;
  --mint:#34d399;
  --amber:#fbbf24;

  --glow-violet: 0 10px 30px rgba(139,92,246,.35);
  --glass: linear-gradient( to bottom right, rgba(18,18,30,.9), rgba(14,14,24,.9) ) padding-box,
           linear-gradient(135deg, var(--sky), var(--violet)) border-box;
}

*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0; font-family: "Segoe UI", Roboto, system-ui, -apple-system, sans-serif;
  color:var(--text); background:var(--bg); overflow:auto;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}

/* ============= Global FX background ============= */
.fx{
  position:fixed; inset:0; z-index:-2; pointer-events:none;
  background:
    radial-gradient(900px 600px at 15% -10%, rgba(96,165,250,.22), transparent 60%),
    radial-gradient(900px 700px at 85% 120%, rgba(139,92,246,.18), transparent 60%),
    linear-gradient(180deg, #090911 0%, #0a0a12 60%, #090911 100%);
}
.fx::before,
.fx::after{
  content:""; position:absolute; inset:-40%;
  background: conic-gradient(from 0turn, rgba(96,165,250,.12), rgba(124,58,237,.12), rgba(236,72,153,.12), rgba(96,165,250,.12));
  filter: blur(60px); animation: swirl 26s linear infinite;
}
.fx::after{ animation-duration: 34s; animation-direction: reverse; opacity: .6; }
@keyframes swirl{ to{ transform: rotate(1turn); } }
/* Subtle grid */
.grid{
  position:fixed; inset:0; z-index:-1; pointer-events:none;
  background:
    linear-gradient(transparent 79px, var(--grid) 80px),
    linear-gradient(90deg, transparent 79px, var(--grid) 80px);
  background-size:80px 80px;
  mask: radial-gradient(60% 60% at 50% 50%, #000 68%, transparent 100%);
}

/* ===== Visibility helpers ===== */
.fade{ transition:opacity .35s ease; }
.hidden{ opacity:0; pointer-events:none; }
.visible{ opacity:1; pointer-events:auto; }

/* ===================== LOGIN ===================== */
#login-screen{
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
  padding:24px; color:#fff; z-index:9999;
}
.login-shell{
  width:min(440px, 94vw); border-radius:22px; padding:3px; background:
    linear-gradient(120deg, #60a5fa, #8b5cf6, #60a5fa);
  box-shadow: 0 26px 80px rgba(0,0,0,.65), 0 0 120px rgba(96,165,250,.35);
}
#login-box{
  border-radius:20px; padding:28px 22px 24px; text-align:center; color:#e8e7ef;
  background:#0b0b10; box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
}
.login-title{
  font-size: clamp(1.6rem, 3.8vw, 2.2rem); font-weight:700; letter-spacing:.3px;
  background: linear-gradient(90deg, #60a5fa, #c084fc 45%, #60a5fa);
  -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
  margin-bottom:18px;
}
#login-error{ min-height:1.2em; margin-bottom:10px; color:#ff6b6b; opacity:0; transition:opacity .3s; }
.input-group{ position:relative; margin:12px 0; }
.input{
  width:100%; padding:14px 14px 14px 50px; border-radius:14px;
  background:#111223; border:1px solid #26263a; color:#e5e7eb; font-size:1rem;
  transition: border-color .2s, box-shadow .2s, background .2s;
}
.input::placeholder{ color:#979bb2; }
.input:focus{ outline:none; border-color:var(--sky); box-shadow:0 0 0 4px rgba(96,165,250,.22), var(--glow-violet); background:#0f1020; }
.input-icon{ position:absolute; top:50%; left:14px; transform:translateY(-50%); width:22px; height:22px; filter: drop-shadow(0 2px 4px rgba(96,165,250,.55)); }

#login-btn{
  width:100%; display:flex; align-items:center; justify-content:center; gap:10px;
  padding:14px 16px; border-radius:14px; cursor:pointer;
  background:#0f0f18; color:#fff; font-weight:700; border:1px solid #2a2b36;
  transition: box-shadow .2s, border-color .2s, transform .05s, filter .2s;
}
#login-btn:hover, #login-btn:focus{ border-color:var(--sky); box-shadow:0 0 0 4px rgba(96,165,250,.18), var(--glow-violet); outline:none; filter:saturate(1.08); }
#login-btn:active{ transform:translateY(1px); }
.btn-icon{ width:20px; height:20px; filter: drop-shadow(0 2px 4px rgba(96,165,250,.45)); }

/* ===================== PAGES ===================== */
.page{ position:absolute; inset:0; opacity:0; pointer-events:none; overflow:auto; }
.page.active{ opacity:1; pointer-events:auto; }

.topbar{
  position:sticky; top:0; z-index:5; padding:12px 16px; backdrop-filter: blur(10px);
  background: linear-gradient( to right, rgba(12,12,22,.72), rgba(11,11,20,.58) );
  border-bottom:1px solid rgba(255,255,255,.06);
  display:flex; align-items:center; justify-content:space-between; gap:8px;
}
.brand{
  font-weight:800; letter-spacing:.4px;
  background: linear-gradient(90deg, var(--sky), var(--violet));
  -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
  font-size: clamp(1.1rem, 2.2vw, 1.5rem);
}
.top-actions{ display:flex; gap:10px; flex-wrap:wrap; }
.chip{
  padding:8px 12px; border-radius:999px; font-size:.9rem; color:#dfe3ff;
  background: linear-gradient(120deg, #121225, #0e0f18); border:1px solid rgba(255,255,255,.08);
}

.container{ max-width:1200px; margin:22px auto 56px; padding:0 16px; }

.kpis{ display:grid; grid-template-columns: repeat(12, 1fr); gap:14px; margin-bottom:16px; }
.card{
  grid-column: span 4; border-radius:16px; padding:16px; background: var(--glass);
  border:2px solid transparent; color:var(--text);
  box-shadow: 0 20px 60px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.03);
  backdrop-filter: blur(10px);
  transition: transform .1s, box-shadow .25s, filter .25s;
}
.card:hover{ transform: translateY(-2px); box-shadow: 0 28px 80px rgba(96,165,250,.28); filter: saturate(1.05); }
.card h4{ margin-bottom:8px; font-weight:700; color:#dfe2ff; }
.stat{ font-size: clamp(1.3rem, 2.6vw, 2rem); font-weight:800; letter-spacing:.2px; }
.stat-gradient{
  background: linear-gradient(90deg, var(--sky), var(--violet));
  -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
}
.muted{ color:var(--muted); font-size:.92rem; }

.balance-panel{ grid-column: span 8; display:flex; align-items:center; gap:18px; }
.actions{ display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
.action-btn{
  display:inline-flex; align-items:center; gap:10px; padding:10px 14px; border-radius:12px; cursor:pointer;
  background: linear-gradient(#0f0f18,#0a0a14) padding-box,
              linear-gradient(135deg, var(--sky), var(--violet)) border-box;
  border:1px solid transparent; color:#fff; font-weight:700; box-shadow: var(--glow-violet);
  transition: transform .06s, box-shadow .2s, filter .2s;
}
.action-btn:hover{ box-shadow: 0 14px 34px rgba(96,165,250,.35); filter:saturate(1.08); }
.action-btn:active{ transform: translateY(1px); }
.action-btn svg{ width:18px; height:18px; }

/* Ring (kept) */
.ring-3d{ position:relative; width:88px; height:88px; display:grid; place-items:center; filter: drop-shadow(0 6px 18px rgba(96,165,250,.18)); }
.ring-3d::before{ content:""; position:absolute; inset:10px; border-radius:50%; background: radial-gradient(60% 60% at 50% 40%, rgba(96,165,250,.16), transparent 70%); pointer-events:none; }
.ring-svg{ width:100%; height:100%; transform:rotate(-90deg); }
.ring-track{ fill:none; stroke:#151b25; stroke-width:12; filter: drop-shadow(0 2px 6px rgba(0,0,0,.5)); opacity:.95; }
.ring-progress{ fill:none; stroke:url(#ringGradBlue); stroke-width:12; stroke-linecap:round; filter:url(#ringGlowBlue); stroke-dasharray: 0 100; transition: stroke-dasharray .8s cubic-bezier(.22,.9,.2,1), stroke .2s; }
.ring-txt{ position:absolute; inset:0; display:grid; place-items:center; font-weight:800; color:#d9ecff; text-shadow: 0 1px 0 rgba(0,0,0,.4); }

/* Facts */
.facts{ grid-column: span 4; }
.kv{ display:flex; justify-content:space-between; padding:10px 0; border-top:1px solid rgba(255,255,255,.07); }
.kv:first-child{ border-top:none; }

/* Overlay + Modal */
.overlay{
  position:fixed; inset:0; background:rgba(0,0,0,.55);
  opacity:0; pointer-events:none; transition:opacity .25s ease; z-index:10000;
}
.overlay.visible{ opacity:1; pointer-events:auto; }
.modal{
  position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(.96);
  width:min(560px, 94vw); border-radius:16px; padding:16px;
  background: var(--glass); border:2px solid transparent; color:var(--text);
  box-shadow: 0 24px 80px rgba(0,0,0,.6), inset 0 0 0 1px rgba(255,255,255,.03);
  backdrop-filter: blur(10px);
  opacity:0; pointer-events:none; transition:opacity .25s ease, transform .25s ease;
  max-height:92vh; overflow:auto; z-index:10001;
}
.modal.visible{ opacity:1; pointer-events:auto; transform:translate(-50%,-50%) scale(1); }
.modal h3{ margin:6px 0 10px; font-weight:800; }
.modal .close-btn{ position:absolute; top:8px; right:10px; font-size:1.3rem; background:none; border:none; color:#c9c7ee; cursor:pointer; }
.hr{ height:1px; background:rgba(255,255,255,.08); margin:10px 0; }

/* Transactions list + search */
.transactions-list{ list-style:none; margin:8px 0 0; padding:0; max-height:420px; overflow:auto; }
.transactions-list .date-header{ font-weight:700; color:#dfe2ff; margin:10px 0 6px; }
.tx-item{ padding:12px; border-radius:12px; margin:10px 0; cursor:pointer; background: linear-gradient(#121222,#0f1020) padding-box, linear-gradient(135deg, rgba(96,165,250,.55), rgba(139,92,246,.55)) border-box; border:1px solid transparent; transition:filter .2s, transform .05s, box-shadow .2s; }
.tx-item:hover{ filter:saturate(1.06); box-shadow: 0 10px 26px rgba(96,165,250,.28); }
.tx-summary{ display:flex; justify-content:space-between; gap:10px; }
.credit{ color:#22c55e; font-weight:700; }
.debit{ color:#f87171; font-weight:700; }

.search-wrap{ display:flex; align-items:center; gap:10px; margin:10px 0 6px; padding:10px 12px; border-radius:12px; background: linear-gradient(#121222,#0f1020) padding-box, linear-gradient(135deg, rgba(96,165,250,.5), rgba(139,92,246,.5)) border-box; border:1px solid transparent; box-shadow: var(--glow-violet); }
.search-wrap svg{ width:18px; height:18px; opacity:.8; }
#tx-search{ flex:1; background:transparent; border:none; outline:none; color:var(--text); font-size:.98rem; padding:4px 0; }
#tx-clear{ background:none; border:none; color:#c9c7ee; cursor:pointer; font-size:1.1rem; line-height:1; padding:2px 6px; border-radius:8px; visibility:hidden; }
#tx-clear:hover{ color:#fff; }

#tx-detail-modal{ padding-top:56px; }
.back-btn{ position:absolute; top:16px; left:14px; background:none; border:none; color:#c9c7ee; cursor:pointer; }

/* ========= Pay Later page ========= */
.pay-header{ display:flex; align-items:center; gap:12px; justify-content:space-between; flex-wrap:wrap; }
.pill{ padding:8px 12px; border-radius:999px; background:#0e0f18; border:1px solid rgba(255,255,255,.08); color:#dfe2ff; }

.section{ border-radius:16px; padding:14px; background: var(--glass); border:2px solid transparent; box-shadow: 0 20px 60px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.03); margin-top:14px; }

.plan-tile{ width:100%; text-align:left; padding:12px 14px; border-radius:12px; background:#111223; border:1px solid #27283a; color:#eaeafb; display:flex; justify-content:space-between; align-items:center; gap:10px; cursor:pointer; transition:transform .06s, box-shadow .25s, filter .2s; }
.plan-tile:hover{ transform:translateY(-1px); box-shadow:0 10px 26px rgba(96,165,250,.25); }
.tile-sub{ color:#aeb1d3; font-size:.92rem; }

.btn-primary{ display:inline-flex; align-items:center; gap:10px; padding:12px 14px; border-radius:12px; cursor:pointer; background: linear-gradient(#0f0f18,#0a0a14) padding-box, linear-gradient(135deg, var(--sky), var(--violet)) border-box; border:1px solid transparent; color:#fff; font-weight:700; box-shadow: var(--glow-violet); }
.btn-ghost{ display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:10px; background:#111223; border:1px solid #2a2b36; color:#e7e7ff; }
.btn-green{ background: linear-gradient(#0f1a13,#0b1510) padding-box, linear-gradient(135deg, #34d399, #10b981) border-box; color:#d8ffe9; }

.help{ color:#a5a3c9; font-size:.92rem; }

/* Plan selector */
.plan-card{ background:#0f1020; border:1px solid #2a2b3a; border-radius:14px; padding:12px; margin:10px 0; overflow:hidden; }
.plan-head{ display:flex; align-items:center; gap:10px; justify-content:space-between; }
.radio{ width:18px; height:18px; border-radius:50%; border:2px solid #6ea1ff; display:inline-grid; place-items:center; cursor:pointer; }
.radio-dot{ width:10px; height:10px; background:#6ea1ff; border-radius:50%; transform:scale(0); transition:transform .18s; }
.radio.checked .radio-dot{ transform:scale(1); }

.krow{ display:flex; justify-content:space-between; padding:10px 0; border-top:1px solid rgba(255,255,255,.07); font-size:1.02rem; }
.krow:first-child{ border-top:none; }
.btn-sched{ margin-top:8px; }

.slide{ max-height:0; opacity:.0; overflow:hidden; transition:max-height .35s ease, opacity .35s ease; }
.slide.open{ max-height:400px; opacity:1; }

/* Virtual card */
.cc-card{ width:min(520px,100%); aspect-ratio: 1.586; position:relative; border-radius:18px; padding:22px; overflow:hidden; background: radial-gradient(120% 140% at 0% 0%, rgba(96,165,250,.22), transparent 60%), radial-gradient(120% 140% at 100% 100%, rgba(236,72,153,.22), transparent 60%), linear-gradient(135deg, #101222, #0b0d18 55%, #0a0a14); border:1px solid rgba(255,255,255,.10); box-shadow: 0 28px 80px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.04); }
.cc-brand{ position:absolute; top:14px; left:16px; font-size:.78rem; letter-spacing:.22rem; font-weight:700; color:#c9c9ffb0; text-transform:uppercase; }
.cc-chip{ position:absolute; top:56px; left:22px; width:50px; height:36px; border-radius:8px; background: linear-gradient(135deg, #e8d9a7, #c8b77a 40%, #fff0c5 70%); box-shadow: inset 0 0 0 1px rgba(0,0,0,.25), 0 4px 12px rgba(0,0,0,.35); }
.cc-visa{ position:absolute; right:18px; bottom:14px; font-weight:900; letter-spacing:.04rem; font-size: clamp(1.1rem, 2.8vw, 1.6rem); color:#e9ecff; opacity:.92; text-shadow: 0 4px 18px rgba(139,92,246,.25); }
.cc-num{ position:absolute; left:22px; bottom:58px; font-weight:800; letter-spacing:.2rem; color:#eef2ff; }
.cc-name{ position:absolute; left:22px; bottom:22px; font-weight:700; color:#eef2ff; }

/* Payment modal */
.option{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; border:1px solid #2a2b36; background:#111223; cursor:pointer; }
.option input{ margin:0; }
.row{ display:flex; gap:10px; }
.row > *{ flex:1; }

.inputBox{ display:flex; flex-direction:column; gap:6px; margin:8px 0; }
.inputBox input{ padding:10px 12px; border-radius:10px; border:1px solid #2a2b36; background:#0f1020; color:#e9e9ff; }
.error{ color:#ff6b6b; font-size:.9rem; min-height:1em; }

/* Mobile tweaks */
@media (max-width: 980px){
  .card{ grid-column: span 6; }
  .balance-panel{ grid-column: span 12; }
  .facts{ grid-column: span 12; }
}
@media (max-width: 640px){
  .card{ grid-column: span 12; }
  .actions{ gap:10px; }
  .action-btn{ width:100%; justify-content:center; }
  .plan-tile{ flex-direction:column; align-items:flex-start; }
}
@media (prefers-reduced-motion: reduce){
  .fade, .modal, #login-btn, .tx-item, .card, .action-btn, .slide{ transition:none !important; }
  .fx::before, .fx::after{ animation:none !important; }
}
</style>
</head>
<body>
  <div class="fx"></div>
  <div class="grid"></div>

  <!-- =================== LOGIN =================== -->
  <div id="login-screen" class="fade visible">
    <div class="login-shell">
      <div id="login-box">
        <h2 class="login-title">Welcome to Sapphire<br/>Checking</h2>

        <div id="login-error">Invalid credentials</div>

        <div class="input-group">
          <svg class="input-icon" viewBox="0 0 24 24" aria-hidden="true">
            <path fill="#60a5fa" d="M12 13.2a5.2 5.2 0 1 0 0-10.4 5.2 5.2 0 0 0 0 10.4Z"/>
            <path fill="#8b5cf6" d="M4.2 20.6c0-3.4 3.9-6.2 7.8-6.2s7.8 2.8 7.8 6.2v.2c0 .7-.6 1.2-1.3 1.2H5.5c-.7 0-1.3-.5-1.3-1.2v-.2Z"/>
          </svg>
          <input id="username" class="input" type="text" placeholder="Username" />
        </div>

        <div class="input-group">
          <svg class="input-icon" viewBox="0 0 24 24" aria-hidden="true">
            <path fill="#60a5fa" d="M17 9h-1V7a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2Zm-8-2a3 3 0 1 1 6 0v2H9V7Zm4 9.7V17a1 1 0 1 0-2 0v-.3a2 2 0 1 0 2 0Z"/>
          </svg>
          <input id="password" class="input" type="password" placeholder="Password" />
        </div>

        <button id="login-btn">
          <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true">
            <path fill="#8b5cf6" d="M12 3a1 1 0 0 1 1 1v5h-2V5H6v14h5v-4h2v5a1 1 0 0 1-1 1H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7Zm8.7 9.3-4-4-1.4 1.4 1.3 1.3H12v2h4.6l-1.3 1.3 1.4 1.4 4-4a1 1 0 0 0 0-1.4Z"/>
          </svg>
          Log In
        </button>
      </div>
    </div>
  </div>

  <!-- =================== CHECKING PAGE =================== -->
  <div id="dashboard" class="hidden fade">
    <div id="checking" class="page active">
      <div class="topbar">
        <div class="brand">Chase Sapphire Checking</div>
        <div class="top-actions">
          <div class="chip">Status: <strong>Active</strong></div>
          <div class="chip">Acct ••••2431</div>
        </div>
      </div>

      <div class="container">
        <div class="kpis">
          <!-- Balance / actions -->
          <div class="card balance-panel">
            <div>
              <h4>Available Balance</h4>
              <div id="bal" class="stat stat-gradient">$414.00</div>
              <div class="actions">
                <button id="show-trans" class="action-btn" title="See recent activity">
                  <svg viewBox="0 0 24 24"><path fill="#60a5fa" d="M4 4h16a1 1 0 0 1 1 1v3H3V5a1 1 0 0 1 1-1zm-1 7h18v7a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-7zm4 2v2h2v-2H7zm4 0v2h6v-2h-6z"/></svg>
                  Recent
                </button>

                <button id="transfer-btn" class="action-btn" title="Transfer">
                  <svg viewBox="0 0 24 24"><path fill="#8b5cf6" d="M4 7h9V4l5 5-5 5v-3H4zM20 17H11v3l-5-5 5-5v3h9z"/></svg>
                  Transfer
                </button>

                <button id="to-paylater" class="action-btn" title="Pay later">
                  <svg viewBox="0 0 24 24"><path fill="#34d399" d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm1 5v4.3l3 1.8-1 1.7-4-2.3V7h2Z"/></svg>
                  Pay later
                </button>
              </div>
            </div>
          </div>

          <!-- Budget/Spending Ring (kept) -->
          <div class="card" style="display:flex; align-items:center; gap:16px;">
            <div class="ring-3d">
              <svg class="ring-svg" viewBox="0 0 120 120" aria-hidden="true">
                <defs>
                  <linearGradient id="ringGradBlue" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0%"  stop-color="#60a5fa"/>
                    <stop offset="100%" stop-color="#8b5cf6"/>
                  </linearGradient>
                  <filter id="ringGlowBlue" x="-50%" y="-50%" width="200%" height="200%">
                    <feGaussianBlur in="SourceGraphic" stdDeviation="2.5" result="blur"/>
                    <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
                  </filter>
                </defs>
                <circle class="ring-track" cx="60" cy="60" r="46"></circle>
                <circle class="ring-progress" id="budgetRing" cx="60" cy="60" r="46" pathLength="100"></circle>
              </svg>
              <span class="ring-txt" id="budgetPct">0%</span>
            </div>
            <div>
              <h4>Budget Used</h4>
              <div class="muted">Monthly budget: <strong id="budgetLbl">$1,000</strong></div>
            </div>
          </div>

          <!-- Account Snapshot -->
          <div class="card facts">
            <h4>Account Snapshot</h4>
            <div class="kv"><span class="muted">Present balance</span><strong id="present">$414.00</strong></div>
            <div class="kv"><span class="muted">Account number</span><strong>501262431</strong></div>
            <div class="kv"><span class="muted">Routing number</span><strong>072000326</strong></div>
            <div class="kv"><span class="muted">Interest rate</span><strong>0.00%</strong></div>
            <div class="kv"><span class="muted">Interest in 2025</span><strong>$0.00</strong></div>
          </div>
        </div>
      </div>
    </div>

    <!-- =================== PAY LATER PAGE =================== -->
    <div id="paylater" class="page">
      <div class="topbar">
        <button id="back-to-checking" class="btn-ghost" title="Back to Checking">← Checking</button>
        <div class="pay-header">
          <div class="brand" style="font-size:1.6rem;">Pay over time</div>
          <div class="pill">Active plans: <strong id="activeCount">0</strong></div>
          <div class="pill">Outstanding: <strong id="outstandingLbl">$0.00</strong></div>
        </div>
      </div>

      <div class="container">
        <div class="section">
          <div id="plansEmpty" class="help">No active plans.</div>
          <div id="plansList" class="col" style="display:flex; flex-direction:column; gap:10px;"></div>
          <div style="margin-top:12px;">
            <button id="open-plan" class="btn-primary">
              <svg viewBox="0 0 24 24" width="18" height="18"><path fill="#a8c8ff" d="M12 5v6H6v2h6v6h2v-6h6v-2h-6V5z"/></svg>
              Plan a purchase
            </button>
          </div>
        </div>

        <div id="planDetail" class="section hidden fade">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div>
              <h3 id="pdTitle" style="margin:6px 0 8px;">Plan details</h3>
              <div class="help" id="pdMeta"></div>
            </div>
            <button id="pd-makePay" class="btn-primary btn-green">
              <svg viewBox="0 0 24 24" width="18" height="18"><path fill="#b7ffd9" d="M12 22a10 10 0 1 1 .001-20.001A10 10 0 0 1 12 22Zm1-14v3.59l2.3 2.3-1.4 1.41L11 12.41V8h2Z"/></svg>
              Make a payment
            </button>
          </div>
          <div class="hr"></div>
          <div id="pdSummary" class="help" style="margin-bottom:8px;"></div>
          <div id="pdSchedule"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============ OVERLAY & MODALS ============ -->
  <div id="overlay" class="overlay"></div>

  <!-- Recent transactions -->
  <div id="trans-modal" class="modal">
    <button id="close-trans" class="close-btn">×</button>
    <h3>Recent transactions</h3>
    <div class="search-wrap">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path fill="#60a5fa" d="M15.5 14h-.8l-.3-.3a6 6 0 1 0-.9.9l.3.3v.8L19 20.5 20.5 19 15.5 14Zm-6 0A4.5 4.5 0 1 1 14 9.5 4.5 4.5 0 0 1 9.5 14Z"/>
      </svg>
      <input id="tx-search" type="text" autocomplete="off" placeholder="Search merchant, amount, date…" />
      <button id="tx-clear" title="Clear">×</button>
    </div>
    <div class="date-header" style="color:var(--muted);">Pending (0)</div>
    <div style="margin-bottom:8px;color:var(--muted);">No pending transactions</div>
    <ul id="tx-list" class="transactions-list"></ul>
  </div>

  <!-- Transaction details -->
  <div id="tx-detail-modal" class="modal">
    <button class="back-btn">← Back</button>
    <h3>Transaction Details</h3>
    <div class="detail-rows"></div>
  </div>

  <!-- Plan a purchase wizard -->
  <div id="plan-modal" class="modal">
    <button id="close-plan" class="close-btn">×</button>
    <h3 id="planStepTitle">Plan a purchase</h3>

    <div id="step1">
      <div class="inputBox">
        <label>Store name</label>
        <input id="storeInput" type="text" placeholder="e.g., Apple" />
      </div>
      <div id="err1" class="error"></div>
      <button id="s1next" class="btn-primary">Continue</button>
    </div>

    <div id="step2" class="hidden fade" style="display:none">
      <div class="inputBox">
        <label>Purchase amount (minimum $50)</label>
        <input id="amtInput" inputmode="numeric" pattern="[0-9]*" placeholder="Enter a whole number (no cents)" />
      </div>
      <div id="err2" class="error"></div>
      <div style="display:flex; gap:8px; margin-top:4px;">
        <button id="s2back" class="btn-ghost">Back</button>
        <button id="s2next" class="btn-primary">Continue</button>
      </div>
    </div>

    <div id="stepLoading" data-disp="grid" class="hidden fade" style="display:none; place-items:center; gap:6px; min-height:120px;">
      <div class="help">Retrieving plans…</div>
    </div>

    <div id="stepPlans" class="hidden fade" style="display:none">
      <div id="plansContainer"></div>
      <div class="hr"></div>
      <label style="display:flex; gap:8px; align-items:center;">
        <input id="agreeTerms" type="checkbox" />
        <span>I agree to the loan terms and the Truth in Lending disclosure.</span>
      </label>
      <div id="agreeErr" class="error"></div>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button id="plansBack" class="btn-ghost">Back</button>
        <button id="activateBtn" class="btn-primary btn-green" disabled>Activate plan</button>
      </div>
    </div>

    <div id="stepActivating" data-disp="grid" class="hidden fade" style="display:none; place-items:center; gap:6px; min-height:120px;">
      <div class="help">Activating plan…</div>
    </div>

    <div id="stepCard" class="hidden fade" style="display:none">
      <div class="help" style="margin-bottom:8px;">Your virtual VISA debit card</div>
      <div id="vcard" class="cc-card" role="button" aria-expanded="false" title="Tap to show details">
        <div class="cc-brand">Sapphire • Pay Later</div>
        <div class="cc-chip" aria-hidden="true"></div>
        <div class="cc-num" id="vcNum">0000 0000 0000 0000</div>
        <div class="cc-name" id="vcName">Virtual Card</div>
        <div class="cc-visa">VISA</div>
      </div>
      <div id="vDetails" class="slide" style="margin-top:8px;">
        <div class="krow"><span>Card number</span><strong id="vNum"></strong></div>
        <div class="krow"><span>Expiry</span><strong id="vExp"></strong></div>
        <div class="krow"><span>Security</span><strong id="vCvv"></strong></div>
      </div>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <button id="cardDone" class="btn-primary">View plan</button>
      </div>
    </div>
  </div>

  <!-- Make a payment modal -->
  <div id="pay-modal" class="modal">
    <button id="close-pay" class="close-btn">×</button>
    <h3>Make a payment</h3>

    <div id="pm-step1">
      <div class="help">Choose amount</div>
      <div style="display:flex; flex-direction:column; gap:8px; margin:8px 0;">
        <label class="option"><input type="radio" name="amtChoice" value="upcoming"> Upcoming payment • <span id="pmUpcomingLbl" style="margin-left:6px;"></span></label>
        <label class="option"><input type="radio" name="amtChoice" value="remaining"> Remaining balance • <span id="pmRemainLbl" style="margin-left:6px;"></span></label>
      </div>
      <div style="display:flex; gap:8px;">
        <button id="pm1next" class="btn-primary">Continue</button>
      </div>
    </div>

    <div id="pm-step2" class="hidden fade" style="display:none">
      <div class="help">Payment method</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;">
        <button id="chooseBank" class="btn-ghost">Bank account</button>
        <button id="chooseCard" class="btn-ghost">Credit / debit card</button>
      </div>
      <div id="bankForm" class="hidden fade" style="display:none">
        <div class="row">
          <div class="inputBox"><label>Routing number</label><input id="bankRouting" inputmode="numeric" maxlength="9" /></div>
          <div class="inputBox"><label>Account number</label><input id="bankAccount" inputmode="numeric" maxlength="17" /></div>
        </div>
      </div>
      <div id="cardForm" class="hidden fade" style="display:none">
        <div class="inputBox"><label>Card number</label><input id="cardNumber" inputmode="numeric" maxlength="19" placeholder="XXXX XXXX XXXX XXXX"/></div>
        <div class="row">
          <div class="inputBox"><label>Expiry (MM/YY)</label><input id="cardExpiry" maxlength="5" placeholder="MM/YY"/></div>
          <div class="inputBox"><label>Security code</label><input id="cardCvv" inputmode="numeric" maxlength="4"/></div>
        </div>
      </div>
      <div id="pmErr" class="error"></div>
      <div style="display:flex; gap:8px;">
        <button id="pm2back" class="btn-ghost">Back</button>
        <button id="pm2next" class="btn-primary">Continue</button>
      </div>
    </div>

    <div id="pm-step3" class="hidden fade" style="display:none">
      <div class="help">Review</div>
      <div class="krow"><span>Amount</span><strong id="pmAmountLbl"></strong></div>
      <div class="krow"><span>Method</span><strong id="pmMethodLbl"></strong></div>
      <div style="display:flex; gap:8px;">
        <button id="pm3back" class="btn-ghost">Back</button>
        <button id="pmMake" class="btn-primary btn-green">Make payment</button>
      </div>
    </div>

    <div id="pm-loading" data-disp="grid" class="hidden fade" style="display:none; place-items:center; gap:6px; min-height:120px;">
      <div class="help">Making payment…</div>
    </div>

    <div id="pm-done" class="hidden fade" style="display:none; grid-gap:6px;">
      <h3>Payment successful</h3>
      <div class="help">We've applied this payment to your final loan amount.</div>
      <div style="text-align:right;">
        <button id="pmClose" class="btn-primary">Close</button>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const overlay     = document.getElementById('overlay');
  const loginScreen = document.getElementById('login-screen');
  const dashboard   = document.getElementById('dashboard');
  const checkingPg  = document.getElementById('checking');
  const paylaterPg  = document.getElementById('paylater');

  /* ========= CHECKING DATA ========= */
  const balance = 414.00;
  const monthlyBudget = 1000; // kept

  // EXACT transactions (unchanged).
  const transactions = [
    { date:'Aug 18, 2025', merchant:'ACH transfer from TOTAL CHECKING (..6750)', amount:64.00,  type:'credit' },
    { date:'Aug 05, 2025', merchant:'Online Transfer from SAVINGS ****9124',     amount:350.00, type:'credit' }
  ];

  /* ========= Utilities ========= */
  const $ = (sel,root=document)=>root.querySelector(sel);
  const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
  const fmtMoney = n => '$' + Number(n).toFixed(2);
  const today = () => new Date();
  const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
  const addMonths = (d,n)=>{ const x=new Date(d); x.setMonth(x.getMonth()+n); return x; };
  const pad = n => n.toString().padStart(2,'0');
  const fmtMDY = d => `${pad(d.getMonth()+1)}/${pad(d.getDate())}/${d.getFullYear()}`;

  function open(m){ overlay.classList.add('visible'); m.classList.add('visible'); }
  function close(m){ m.classList.remove('visible'); overlay.classList.remove('visible'); }

  /* ========= Budget ring ========= */
  const ring = document.getElementById('budgetRing');
  const ringTxt = document.getElementById('budgetPct');
  function calcMonthSpending(list){
    const now = new Date(); const m = now.getMonth(), y = now.getFullYear();
    return list
      .filter(t => { const d=new Date(t.date+' 00:00:00'); return d.getMonth()===m && d.getFullYear()===y && t.amount < 0; })
      .reduce((s,t)=>s + Math.abs(t.amount), 0);
  }
  function setBudgetProgress(spent, budget){
    const pct = Math.max(0, Math.min(100, (spent/budget)*100));
    ring.style.strokeDasharray = `${pct} 100`;
    ringTxt.textContent = `${Math.round(pct)}%`;
    let color = '#34d399';
    if (pct >= 80) color = '#8b5cf6';
    else if (pct >= 50) color = '#fbbf24';
    ring.style.stroke = color;
    ring.style.filter = `drop-shadow(0 6px 16px ${color}66)`;
  }
  const spentThisMonth = calcMonthSpending(transactions);
  setBudgetProgress(spentThisMonth, monthlyBudget);
  $('#budgetLbl').textContent = fmtMoney(monthlyBudget);
  $('#bal').textContent = fmtMoney(balance);
  $('#present').textContent = fmtMoney(balance);

  /* ========= Transactions modal ========= */
  const txListEl = document.getElementById('tx-list');
  function renderList(list = transactions){
    txListEl.innerHTML = '';
    if (!list.length){
      txListEl.innerHTML = '<li class="muted" style="padding:12px 6px;">No matches.</li>';
      return;
    }
    const byDate = {};
    list.forEach(t => { (byDate[t.date] ??= []).push(t); });

    Object.entries(byDate).forEach(([date, items])=>{
      const header = document.createElement('div');
      header.className = 'date-header';
      header.textContent = `${date} (${items.length})`;
      txListEl.appendChild(header);

      items.forEach(tx => {
        const li = document.createElement('li');
        li.className = 'tx-item';
        const amountDisplay = fmtMoney(Math.abs(tx.amount)).replace('$', '$'+(tx.amount>=0?'+':'-'));
        li.innerHTML = `
          <div class="tx-summary">
            <span>${tx.merchant}</span>
            <span class="${tx.amount >= 0 ? 'credit' : 'debit'}">${amountDisplay}</span>
          </div>`;
        li.addEventListener('click', () => openDetail(tx));
        txListEl.appendChild(li);
      });
    });
  }
  renderList();

  function openDetail(tx){
    const dm = document.getElementById('tx-detail-modal');
    const cont = dm.querySelector('.detail-rows');
    const rows = [
      {label:'Merchant', value: tx.merchant},
      {label:'Date',     value: tx.date},
      {label:'Amount',   value: (tx.amount>=0?'+':'-') + fmtMoney(Math.abs(tx.amount))},
      {label:'Type',     value: tx.type}
    ];
    cont.innerHTML = rows.map(r=>`<div class="krow"><span class="row-label">${r.label}</span><strong>${r.value}</strong></div>`).join('');
    close($('#trans-modal'));
    open(dm);
  }

  const searchInput = document.getElementById('tx-search');
  const clearBtn    = document.getElementById('tx-clear');
  function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
  function filterTx(q){
    if(!q) return transactions;
    const tokens = q.trim().toLowerCase().split(/\s+/).map(escapeRegExp);
    return transactions.filter(tx => {
      const hay = `${tx.merchant} ${tx.date} ${tx.amount.toFixed(2)} ${tx.type}`.toLowerCase();
      return tokens.every(t => new RegExp(`(^|\\b|\\s)${t}`).test(hay));
    });
  }
  $('#show-trans').onclick = () => { open($('#trans-modal')); renderList(filterTx(searchInput.value)); setTimeout(()=>searchInput.focus(), 40); };
  $('#close-trans').onclick = () => close($('#trans-modal'));
  document.querySelector('#tx-detail-modal .back-btn').onclick = () => { close($('#tx-detail-modal')); open($('#trans-modal')); };
  searchInput.addEventListener('input', () => { const q = searchInput.value; renderList(filterTx(q)); clearBtn.style.visibility = q ? 'visible' : 'hidden'; });
  clearBtn.addEventListener('click', () => { searchInput.value = ''; renderList(transactions); clearBtn.style.visibility = 'hidden'; searchInput.focus(); });

  // Placeholder transfer
  $('#transfer-btn').onclick = () => alert('Transfers feature is not included in this demo.');

  /* ========= Navigation ========= */
  $('#to-paylater').onclick = () => { checkingPg.classList.remove('active'); paylaterPg.classList.add('active'); };
  $('#back-to-checking').onclick = () => { paylaterPg.classList.remove('active'); checkingPg.classList.add('active'); };

  /* ========= Pay Later persistence ========= */
  const LS_KEY = 'sapphirePlansV1';
  let plans = [];
  function savePlans(){ localStorage.setItem(LS_KEY, JSON.stringify(plans)); }
  function loadPlans(){ try{ plans = JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ plans = []; } }
  loadPlans();

  const planOutstanding = p => p.schedule.filter(s=>!s.paid).reduce((a,b)=>a+b.amount,0);
  const nextUnpaid = p => p.schedule.find(s=>!s.paid) || null;

  function refreshPayLater(){
    $('#activeCount').textContent = plans.length;
    const totalOutstanding = plans.reduce((s,p)=>s+planOutstanding(p),0);
    $('#outstandingLbl').textContent = fmtMoney(totalOutstanding);

    const list = $('#plansList');
    const empty = $('#plansEmpty');
    list.innerHTML = '';
    empty.style.display = plans.length ? 'none' : 'block';

    plans.forEach(p => {
      const nu = nextUnpaid(p);
      const tile = document.createElement('button');
      tile.className = 'plan-tile';
      tile.innerHTML = `
        <div>
          <div style="font-weight:800">${p.store}</div>
          <div class="tile-sub">${p.planLabel} • Total ${fmtMoney(p.amount)}</div>
        </div>
        <div class="tile-sub">${nu ? `Next due ${fmtMDY(new Date(nu.date))} • ${fmtMoney(nu.amount)}` : 'Paid'}</div>
      `;
      tile.addEventListener('click', () => openPlanDetail(p.id));
      list.appendChild(tile);
    });
  }
  refreshPayLater();

  /* ========= Plan details ========= */
  let currentPlanId = null;

  function openPlanDetail(id){
    currentPlanId = id;
    const p = plans.find(x=>x.id===id);
    $('#planDetail').classList.remove('hidden');
    $('#pdTitle').textContent = `${p.store} — ${p.planLabel}`;
    $('#pdMeta').textContent = `Created ${fmtMDY(new Date(p.created))} • Outstanding ${fmtMoney(planOutstanding(p))}`;

    const s = $('#pdSchedule');
    s.innerHTML = `
      <div class="krow"><span>Total</span><strong>${fmtMoney(p.amount)}</strong></div>
      <div class="hr"></div>
      ${p.schedule.map((i,idx)=>`
        <div class="krow">
          <span>${idx===0 && i.type==='downpayment' ? 'Downpayment' : 'Payment ' + (i.type==='downpayment'?0:idx)}</span>
          <strong>${fmtMDY(new Date(i.date))} • ${fmtMoney(i.amount)}${i.paid? ' • PAID':''}</strong>
        </div>
      `).join('')}
    `;
    $('#pdSummary').textContent = nextUnpaid(p) ? `Next payment on ${fmtMDY(new Date(nextUnpaid(p).date))}` : 'Plan paid off.';
  }

  $('#pd-makePay').onclick = () => {
    if(!currentPlanId) return;
    // reset payment wizard each time
    $$('input[name="amtChoice"]').forEach(r=>r.checked=false);
    $('#bankRouting').value=''; $('#bankAccount').value='';
    $('#cardNumber').value=''; $('#cardExpiry').value=''; $('#cardCvv').value='';
    $('#bankForm').style.display='none'; $('#bankForm').classList.add('hidden');
    $('#cardForm').style.display='none'; $('#cardForm').classList.add('hidden');
    pmChoice=null; pmMethod=null; pmAmount=0; pmMethodText='';
    const p = plans.find(x=>x.id===currentPlanId);
    const upcoming = nextUnpaid(p);
    $('#pmUpcomingLbl').textContent = upcoming ? fmtMoney(upcoming.amount) : fmtMoney(0);
    $('#pmRemainLbl').textContent = fmtMoney(planOutstanding(p));
    showStep('pm-step1');
    open($('#pay-modal'));
  };

  /* ========= Plan a purchase flow ========= */
  const planModal = $('#plan-modal');
  $('#open-plan').onclick = ()=>{
    resetWizard();
    open(planModal);
    setTimeout(()=>$('#storeInput').focus(), 50); // ensure keyboard shows on mobile
  };
  $('#close-plan').onclick = ()=>close(planModal);

  // step visibility helper toggling display according to data-disp
  function setStepVisible(el, show){
    if(!el) return;
    if(show){ el.style.display = el.dataset.disp || 'block'; el.classList.remove('hidden'); el.classList.add('visible'); }
    else{ el.style.display='none'; el.classList.add('hidden'); el.classList.remove('visible'); }
  }
  function showWiz(stepId){
    ['step1','step2','stepLoading','stepPlans','stepActivating','stepCard'].forEach(id=>{
      setStepVisible(document.getElementById(id), id===stepId);
    });
  }
  function resetWizard(){
    $('#storeInput').value = '';
    $('#amtInput').value = '';
    $('#err1').textContent=''; $('#err2').textContent='';
    $('#agreeTerms').checked=false; $('#agreeErr').textContent='';
    $('#activateBtn').disabled = true;
    selectedPlanChoice = null; tempPlan = null;
    showWiz('step1');
  }

  let selectedPlanChoice = null; // 'biweekly'|'6m'|'12m'
  let tempPlan = null; // preview during activation

  $('#s1next').onclick = () => {
    const name = $('#storeInput').value.trim();
    if(!name){ $('#err1').textContent = 'Please enter a store name.'; return; }
    $('#err1').textContent='';
    showWiz('step2');
  };

  // numbers only for amount
  $('#amtInput').addEventListener('input', (e)=>{ e.target.value = e.target.value.replace(/\D/g,''); });

  $('#s2back').onclick = ()=>showWiz('step1');
  $('#s2next').onclick = () => {
    const amtStr = $('#amtInput').value.trim();
    if(!amtStr){ $('#err2').textContent = 'Enter an amount.'; return; }
    const amt = parseInt(amtStr,10);
    if(isNaN(amt) || amt < 50){ $('#err2').textContent = 'Amount must be at least $50 (whole dollars only).'; return; }
    $('#err2').textContent='';
    showWiz('stepLoading');                 // <-- now visibly shows as grid
    setTimeout(()=>generatePlanOptions($('#storeInput').value.trim(), amt), 4000);
  };

  function splitEven(total, parts){
    const base = Math.floor((total/parts)*100)/100;
    const arr = Array(parts).fill(base);
    let sum = arr.reduce((a,b)=>a+b,0);
    arr[arr.length-1] += +(total - sum).toFixed(2);
    return arr;
  }

  function buildSchedule(amount, type){
    const start = today();
    if(type==='biweekly'){
      const pieces = splitEven(amount, 4);
      return [
        {label:'Downpayment', type:'downpayment', date:fmtMDY(start),             amount:pieces[0], paid:false},
        {label:'Payment 1',   type:'payment',     date:fmtMDY(addDays(start,14)), amount:pieces[1], paid:false},
        {label:'Payment 2',   type:'payment',     date:fmtMDY(addDays(start,28)), amount:pieces[2], paid:false},
        {label:'Payment 3',   type:'payment',     date:fmtMDY(addDays(start,42)), amount:pieces[3], paid:false},
      ];
    }
    if(type==='6m'){
      const pieces = splitEven(amount, 6);
      return pieces.map((a,i)=>({label:`Payment ${i+1}`, type:'payment', date:fmtMDY(addMonths(start, i+1)), amount:a, paid:false}));
    }
    const pieces = splitEven(amount, 12);
    return pieces.map((a,i)=>({label:`Payment ${i+1}`, type:'payment', date:fmtMDY(addMonths(start, i+1)), amount:a, paid:false}));
  }

  function optionCard({key,label,sub,amount,firstDue}){
    const wrap = document.createElement('div');
    wrap.className = 'plan-card';
    wrap.innerHTML = `
      <div class="plan-head">
        <div>
          <div style="font-weight:800">${label}</div>
          <div class="help">${sub}</div>
        </div>
        <div class="radio" data-k="${key}" role="button" aria-label="${label}"><div class="radio-dot"></div></div>
      </div>
      <div class="krow"><span>Payment</span><strong id="${key}-pay">${amount}</strong></div>
      <div class="krow"><span>First due</span><strong id="${key}-due">${firstDue}</strong></div>
      <button class="btn-ghost btn-sched" data-expand="${key}">View schedule</button>
      <div id="${key}-sched" class="slide"></div>
    `;
    return wrap;
  }

  function generatePlanOptions(store, amount){
    const wrap = $('#plansContainer'); wrap.innerHTML='';
    const bi = buildSchedule(amount,'biweekly');
    const s6 = buildSchedule(amount,'6m');
    const s12= buildSchedule(amount,'12m');

    const biEl = optionCard({
      key:'bi', label:'Bi-weekly', sub:'4 payments (first due today as downpayment)',
      amount: fmtMoney(bi[0].amount) + ' / bi-weekly', firstDue: `${fmtMDY(new Date())} (downpayment)`
    });
    const s6El = optionCard({
      key:'m6', label:'6 months', sub:'Equal monthly payments',
      amount: fmtMoney(s6[0].amount) + ' / month', firstDue: fmtMDY(new Date(s6[0].date))
    });
    wrap.appendChild(biEl); wrap.appendChild(s6El);
    if(amount>100){
      const s12El = optionCard({
        key:'m12', label:'12 months', sub:'Lower monthly payments',
        amount: fmtMoney(s12[0].amount) + ' / month', firstDue: fmtMDY(new Date(s12[0].date))
      });
      wrap.appendChild(s12El);
    }

    // schedule viewers and radio selection
    wrap.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-expand]');
      const radio = e.target.closest('.radio');
      if(btn){
        const k = btn.getAttribute('data-expand');
        const panel = document.getElementById(k+'-sched');
        if(!panel.dataset.rendered){
          const items = k==='bi'?bi : (k==='m6'?s6:s12);
          panel.innerHTML = items.map(i=>`<div class="krow"><span>${i.label}</span><strong>${i.date} • ${fmtMoney(i.amount)}${i.type==='downpayment'?' (downpayment)':''}</strong></div>`).join('');
          panel.dataset.rendered = '1';
        }
        panel.classList.toggle('open');
        btn.textContent = panel.classList.contains('open') ? 'Hide schedule' : 'View schedule';
      }
      if(radio){
        $$('.radio',wrap).forEach(r=>r.classList.remove('checked'));
        radio.classList.add('checked');
        selectedPlanChoice = radio.dataset.k==='bi' ? 'biweekly' : (radio.dataset.k==='m6' ? '6m' : '12m');
        $('#activateBtn').disabled = !($('#agreeTerms').checked && selectedPlanChoice);
      }
    });

    $('#agreeTerms').onchange = ()=>{ $('#activateBtn').disabled = !(selectedPlanChoice && $('#agreeTerms').checked); };

    $('#plansBack').onclick = ()=>showWiz('step2');

    $('#activateBtn').onclick = ()=>{
      if(!selectedPlanChoice || !$('#agreeTerms').checked){ $('#agreeErr').textContent='Please select a plan and agree to the terms.'; return; }
      $('#agreeErr').textContent='';
      const schedule = selectedPlanChoice==='biweekly'? bi : (selectedPlanChoice==='6m'? s6 : s12);
      tempPlan = {
        id: 'pl-'+Date.now(),
        created: new Date().toISOString(),
        store, amount,
        planType: selectedPlanChoice,
        planLabel: selectedPlanChoice==='biweekly' ? 'Bi-weekly' : (selectedPlanChoice==='6m' ? '6 months' : '12 months'),
        schedule
      };
      showWiz('stepActivating');                // <-- now visibly shows as grid
      setTimeout(()=>showVirtualCard(), 5000);
    };

    showWiz('stepPlans');
  }

  function showVirtualCard(){
    // generate fake card
    const num = Array(16).fill(0).map(()=>Math.floor(Math.random()*10)).join('').replace(/(\d{4})(?=\d)/g,'$1 ');
    const exp = `${pad((today().getMonth()+1))}/${(today().getFullYear()+3).toString().slice(-2)}`;
    const cvv = String(Math.floor(100+Math.random()*900));
    $('#vcNum').textContent = num; $('#vNum').textContent = num; $('#vExp').textContent = exp; $('#vCvv').textContent = cvv;

    // save plan now
    plans.push(tempPlan); savePlans(); refreshPayLater(); openPlanDetail(tempPlan.id);

    // reveal details on tap
    $('#vcard').onclick = ()=>{
      const panel = $('#vDetails');
      panel.classList.toggle('open');
    };
    $('#cardDone').onclick = ()=>{ close(planModal); };

    showWiz('stepCard');
  }

  /* ========= Make a payment flow ========= */
  const payModal = $('#pay-modal');
  $('#close-pay').onclick = ()=>close(payModal);
  $('#pmClose').onclick = ()=>{ close(payModal); if(currentPlanId){ openPlanDetail(currentPlanId); } refreshPayLater(); };

  function setPayStep(id){
    ['pm-step1','pm-step2','pm-step3','pm-loading','pm-done'].forEach(s=>{
      const el = document.getElementById(s);
      if(!el) return;
      if(s===id){ el.style.display = el.dataset.disp || 'block'; el.classList.remove('hidden'); el.classList.add('visible'); }
      else{ el.style.display='none'; el.classList.add('hidden'); el.classList.remove('visible'); }
    });
    $('#pmErr').textContent='';
  }
  const showStep = setPayStep;

  let pmChoice = null; // 'upcoming'|'remaining'
  let pmMethod = null; // 'bank'|'card'
  let pmAmount = 0;
  let pmMethodText = '';

  $('#pm1next').onclick = ()=>{
    const sel = $$('input[name="amtChoice"]').find(i=>i.checked);
    if(!sel){ alert('Choose an amount.'); return; }
    pmChoice = sel.value;
    const p = plans.find(x=>x.id===currentPlanId);
    pmAmount = pmChoice==='upcoming' ? (nextUnpaid(p)?.amount || 0) : planOutstanding(p);
    showStep('pm-step2');
  };

  $('#chooseBank').onclick = ()=>{ pmMethod='bank'; $('#bankForm').style.display='block'; $('#bankForm').classList.remove('hidden'); $('#cardForm').style.display='none'; $('#cardForm').classList.add('hidden'); };
  $('#chooseCard').onclick = ()=>{ pmMethod='card'; $('#cardForm').style.display='block'; $('#cardForm').classList.remove('hidden'); $('#bankForm').style.display='none'; $('#bankForm').classList.add('hidden'); };

  $('#pm2back').onclick = ()=>showStep('pm-step1');
  $('#pm2next').onclick = ()=>{
    if(pmMethod==='bank'){
      const r = $('#bankRouting').value.trim();
      const a = $('#bankAccount').value.trim();
      if(!/^\d{9}$/.test(r) || !/^\d{4,17}$/.test(a)){ $('#pmErr').textContent='Enter a valid routing (9 digits) and account number (4–17 digits).'; return; }
      pmMethodText = `Bank • ****${a.slice(-4)}`;
    }else if(pmMethod==='card'){
      const n = $('#cardNumber').value.replace(/\s+/g,'');
      const e = $('#cardExpiry').value.trim();
      const c = $('#cardCvv').value.trim();
      if(!/^\d{16}$/.test(n) || !/^\d{2}\/\d{2}$/.test(e) || !/^\d{3,4}$/.test(c)){ $('#pmErr').textContent='Enter a valid card number, expiry (MM/YY) and security code.'; return; }
      pmMethodText = `Card • ****${n.slice(-4)}`;
    }else{
      $('#pmErr').textContent='Choose a payment method.';
      return;
    }
    $('#pmAmountLbl').textContent = fmtMoney(pmAmount);
    $('#pmMethodLbl').textContent = pmMethodText;
    showStep('pm-step3');
  };

  $('#pm3back').onclick = ()=>showStep('pm-step2');

  $('#pmMake').onclick = ()=>{
    showStep('pm-loading');             // <-- visible grid loading
    setTimeout(()=>{
      // apply payment
      const p = plans.find(x=>x.id===currentPlanId);
      if(pmChoice==='remaining'){
        p.schedule.forEach(s=> s.paid = true);
      }else{
        const nu = nextUnpaid(p);
        if(nu) nu.paid = true;
      }
      savePlans();
      refreshPayLater();
      if(planOutstanding(p) <= 0){
        plans = plans.filter(x=>x.id!==p.id); savePlans(); refreshPayLater();
        $('#pdTitle').textContent = 'Plan paid off';
        $('#pdSchedule').innerHTML = '';
        $('#pdSummary').textContent = 'This plan has been paid and removed.';
      }else{
        openPlanDetail(p.id);
      }
      showStep('pm-done');
    }, 5000);
  };

  /* ========= Login ========= */
  function tryLogin(){
    const u = $('#username').value.trim();
    const p = $('#password').value;
    const err = document.getElementById('login-error');
    if (u && p){
      loginScreen.classList.remove('visible');
      loginScreen.classList.add('hidden');
      setTimeout(() => {
        dashboard.classList.remove('hidden');
        dashboard.classList.add('visible');
      }, 250);
    } else {
      err.textContent = 'Enter username & password';
      err.style.opacity = '1';
      setTimeout(() => err.style.opacity = '0', 1600);
    }
  }
  document.getElementById('login-btn').addEventListener('click', tryLogin);
  ['username','password'].forEach(id=>{
    document.getElementById(id).addEventListener('keydown', e => { if(e.key==='Enter') tryLogin(); });
  });
});
</script>
</body>
</html>
